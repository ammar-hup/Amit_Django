Below is a **complete, ready-to-copy integration** of **Activision-style email confirmation + password reset** into **your existing AMIT Blog project**.

We will:
- Replace `Author` with `ActivisionUser` (custom user with `activision_id`)
- Add **email activation** on signup
- Add **secure password reset**
- Reuse **Django’s built-in auth views**
- Keep **your existing blog logic** intact
- Use **SMTP or console email** (configurable)

---

## 1. Project Structure (Updated)

```
amit_blog/
├── blog/
│   ├── models.py        ← Post
│   └── ...
├── accounts/            ← NEW APP
│   ├── migrations/
│   ├── __init__.py
│   ├── admin.py
│   ├── apps.py
│   ├── models.py        ← ActivisionUser
│   ├── views.py
│   ├── forms.py
│   ├── utils.py
│   ├── urls.py
│   └── templates/
│       └── accounts/
│           ├── signup.html
│           ├── activation_email.html
│           ├── activation_complete.html
│           ├── password_reset_email.html
│           └── ...
├── templates/
│   └── base.html
├── manage.py
└── amit_blog/
    ├── settings.py
    └── urls.py
```

---

## 2. Step-by-Step Integration

---

### STEP 1: Create `accounts` App

```bash
python manage.py startapp accounts
```

---

### STEP 2: `accounts/models.py`

```python
# accounts/models.py
from django.contrib.auth.models import AbstractUser
from django.db import models
from django.utils import timezone

class ActivisionUser(AbstractUser):
    activision_id = models.CharField(max_length=50, unique=True, blank=True, null=True)
    is_active = models.BooleanField(default=False)  # Inactive until email confirmed
    date_joined = models.DateTimeField(default=timezone.now)

    def __str__(self):
        return self.username
```

---

### STEP 3: `accounts/utils.py` (Token Generator)

```python
# accounts/utils.py
from django.contrib.auth.tokens import PasswordResetTokenGenerator
import six

class AccountActivationTokenGenerator(PasswordResetTokenGenerator):
    def _make_hash_value(self, user, timestamp):
        return (
            six.text_type(user.pk) + six.text_type(timestamp) +
            six.text_type(user.is_active)
        )

account_activation_token = AccountActivationTokenGenerator()
```

---

### STEP 4: `accounts/forms.py`

```python
# accounts/forms.py
from django import forms
from django.contrib.auth.forms import UserCreationForm
from .models import ActivisionUser

class ActivisionSignupForm(UserCreationForm):
    email = forms.EmailField(required=True)
    activision_id = forms.CharField(max_length=50, required=False, label="Activision ID (optional)")

    class Meta:
        model = ActivisionUser
        fields = ('username', 'email', 'activision_id', 'password1', 'password2')

    def save(self, commit=True):
        user = super().save(commit=False)
        user.email = self.cleaned_data['email']
        if commit:
            user.save()
        return user
```

---

### STEP 5: `accounts/views.py`

```python
# accounts/views.py
from django.contrib.auth import login
from django.contrib.auth.views import PasswordResetView, PasswordResetDoneView
from django.contrib.sites.shortcuts import get_current_site
from django.core.mail import send_mail
from django.shortcuts import render, redirect
from django.template.loader import render_to_string
from django.utils.encoding import force_bytes
from django.utils.http import urlsafe_base64_encode, urlsafe_base64_decode
from django.views import View
from .forms import ActivisionSignupForm
from .models import ActivisionUser
from .utils import account_activation_token

# ---------- SIGNUP + EMAIL CONFIRM ----------
class SignupView(View):
    def get(self, request):
        form = ActivisionSignupForm()
        return render(request, 'accounts/signup.html', {'form': form})

    def post(self, request):
        form = ActivisionSignupForm(request.POST)
        if form.is_valid():
            user = form.save(commit=False)
            user.is_active = False
            user.save()

            current_site = get_current_site(request)
            mail_subject = 'Activate your AMIT Blog account'
            message = render_to_string('accounts/activation_email.html', {
                'user': user,
                'domain': current_site.domain,
                'uid': urlsafe_base64_encode(force_bytes(user.pk)),
                'token': account_activation_token.make_token(user),
            })
            send_mail(
                mail_subject,
                message,
                'no-reply@amitblog.com',
                [user.email],
                fail_silently=False,
            )
            return redirect('activation_sent')
        return render(request, 'accounts/signup.html', {'form': form})

def activate(request, uidb64, token):
    try:
        uid = urlsafe_base64_decode(uidb64).decode()
        user = ActivisionUser.objects.get(pk=uid)
    except (TypeError, ValueError, OverflowError, ActivisionUser.DoesNotExist):
        user = None

    if user and account_activation_token.check_token(user, token):
        user.is_active = True
        user.save()
        login(request, user)
        return render(request, 'accounts/activation_complete.html')
    else:
        return render(request, 'accounts/activation_invalid.html')

# ---------- PASSWORD RESET ----------
class CustomPasswordResetView(PasswordResetView):
    email_template_name = 'accounts/password_reset_email.html'
    subject_template_name = 'accounts/password_reset_subject.txt'
    template_name = 'accounts/password_reset_form.html'

class CustomPasswordResetDoneView(PasswordResetDoneView):
    template_name = 'accounts/password_reset_done.html'
```

---

### STEP 6: `accounts/urls.py`

```python
# accounts/urls.py
from django.urls import path
from django.contrib.auth import views as auth_views
from . import views

urlpatterns = [
    # Signup & activation
    path('signup/', views.SignupView.as_view(), name='signup'),
    path('activate/<uidb64>/<token>/', views.activate, name='activate'),
    path('activation-sent/', lambda r: render(r, 'accounts/activation_sent.html'), name='activation_sent'),

    # Password reset
    path('password_reset/', views.CustomPasswordResetView.as_view(), name='password_reset'),
    path('password_reset/done/', views.CustomPasswordResetDoneView.as_view(), name='password_reset_done'),
    path('reset/<uidb64>/<token>/', auth_views.PasswordResetConfirmView.as_view(
        template_name='accounts/password_reset_confirm.html'), name='password_reset_confirm'),
    path('reset/done/', auth_views.PasswordResetCompleteView.as_view(
        template_name='accounts/password_reset_complete.html'), name='password_reset_complete'),
]
```

---

### STEP 7: Project `urls.py`

```python
# amit_blog/urls.py
from django.contrib import admin
from django.urls import path, include

urlpatterns = [
    path('admin/', admin.site.urls),
    path('accounts/', include('accounts.urls')),
    path('', include('blog.urls')),
    path('', include('django.contrib.auth.urls')),  # login/logout
]
```

---

### STEP 8: Update `settings.py`

```python
# amit_blog/settings.py
INSTALLED_APPS += [
    'django.contrib.sites',
    'accounts',
]

SITE_ID = 1
AUTH_USER_MODEL = 'accounts.ActivisionUser'

# Email settings
EMAIL_BACKEND = 'django.core.mail.backends.console.EmailBackend'  # Use SMTP in prod
# EMAIL_BACKEND = 'django.core.mail.backends.smtp.EmailBackend'
# EMAIL_HOST = 'smtp.gmail.com'
# EMAIL_PORT = 587
# EMAIL_USE_TLS = True
# EMAIL_HOST_USER = 'your@gmail.com'
# EMAIL_HOST_PASSWORD = 'app_password'
DEFAULT_FROM_EMAIL = 'AMIT Blog <no-reply@amitblog.com>'

# Activation link expires in 3 days
ACCOUNT_ACTIVATION_DAYS = 3

# Password reset link expires in 24 hours
PASSWORD_RESET_TIMEOUT = 3600 * 24

# Auth redirects
LOGIN_REDIRECT_URL = '/'
LOGOUT_REDIRECT_URL = '/'
LOGIN_URL = 'login'
```

---

### STEP 9: Update `blog/models.py` (Use new user)

```python
# blog/models.py
from django.db import models
from django.utils import timezone
from accounts.models import ActivisionUser  # ← Change import

class Post(models.Model):
    title = models.CharField(max_length=200)
    content = models.TextField()
    created_at = models.DateTimeField(default=timezone.now)
    published = models.BooleanField(default=False)
    author = models.ForeignKey(ActivisionUser, on_delete=models.CASCADE, related_name='posts')

    def __str__(self):
        return self.title

    class Meta:
        ordering = ['-created_at']
```

---

### STEP 10: Update `blog/views.py` (Use new user)

```python
# In post_create, post_update, etc.
author, created = ActivisionUser.objects.get_or_create(user=request.user)
# → Remove this line! request.user IS the ActivisionUser
```

**Replace with:**
```python
post.author = request.user  # ← Direct!
```

---

### STEP 11: Email Templates

#### `accounts/templates/accounts/activation_email.html`
```html
Subject: Activate your AMIT Blog account

Hi {{ user.username }},

Please click the link below to confirm your email and activate your account:

http://{{ domain }}{% url 'activate' uid token %}

This link will expire in {{ ACCOUNT_ACTIVATION_DAYS }} days.

Thanks,
AMIT Blog Team
```

#### `accounts/templates/accounts/password_reset_email.html`
```html
{% autoescape off %}
Someone requested a password reset for {{ email }}.

Click below to reset:
{{ protocol }}://{{ domain }}{% url 'password_reset_confirm' uidb64 token %}

Username: {{ user.get_username }}
{% endautoescape %}
```

#### `accounts/templates/accounts/password_reset_subject.txt`
```
Password reset on AMIT Blog
```

---

### STEP 12: Simple HTML Pages

#### `accounts/templates/accounts/signup.html`
```html
{% extends 'blog/base.html' %}
{% block title %}Sign Up - AMIT Blog{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-danger text-white">
                    <h3>Sign Up</h3>
                </div>
                <div class="card-body">
                    <form method="post">
                        {% csrf_token %}
                        {{ form.as_p }}
                        <button type="submit" class="btn btn-danger">Create Account</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
```

#### `accounts/templates/accounts/activation_sent.html`
```html
{% extends 'blog/base.html' %}
{% block content %}
<div class="alert alert-info text-center">
    <h4>Check your email!</h4>
    <p>We sent an activation link to your inbox.</p>
</div>
{% endblock %}
```

#### `accounts/templates/accounts/activation_complete.html`
```html
{% extends 'blog/base.html' %}
{% block content %}
<div class="alert alert-success text-center">
    <h4>Account activated!</h4>
    <p>Welcome! You can now <a href="{% url 'login' %}">log in</a>.</p>
</div>
{% endblock %}
```

---

### STEP 13: Run Migrations (Fresh DB Recommended)

```bash
# Backup first!
rm db.sqlite3
rm -r accounts/migrations/ blog/migrations/
python manage.py makemigrations accounts blog
python manage.py migrate
python manage.py createsuperuser
```

---

## Final Flow

1. **User visits `/accounts/signup/`**
2. **Fills form → email sent**
3. **Clicks link → account activated → auto-login**
4. **Can now create posts**
5. **Forgot password? → `/accounts/password_reset/` → secure reset**

---

## Security Checklist (All Done)

| Feature                      | Status |
|-----------------------------|--------|
| Custom user model           | Yes    |
| Email confirmation          | Yes    |
| Secure token (uid+token)    | Yes    |
| `is_active=False` until confirm | Yes |
| Password reset (Django)     | Yes    |
| Email templates             | Yes    |
| Console email in dev        | Yes    |
| SMTP ready                  | Yes    |

---

## Git Branch

```bash
git checkout -b feature/activision-auth
git add .
git commit -m "Add email confirmation + password reset with ActivisionUser"
git push origin feature/activision-auth
```

---

**You’re done!**  
Your **AMIT Blog** now has **Activision-grade auth** — secure, professional, and ready for production.

**Save this as:** `activision_auth_integration.md`  
**Next session**: Testing + Deployment

Want **Session 8 plan** now? Say: **“Session 8 plan”**